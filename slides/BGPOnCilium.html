<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.4.553">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>bgponcilium</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<script src="../site_libs/quarto-html/quarto.js"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>


</head>

<body class="fullcontent">

<div id="quarto-search-results"></div>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
<!-- margin-sidebar -->
    
<!-- main -->
<main class="content" id="quarto-document-content">




<p>ü•à BGP on Cilium A Kubernetes and Cilium hands-on lab by Isovalent</p>
<p>üåê BGP is a Data Center Standard</p>
<p>BGP is not just the foundational protocol behind the Internet; it is now the standard within data centers.</p>
<p>Modern data center network fabrics are typically based on a ‚Äúleaf-and-spine‚Äù architecture where BGP is typically used to propagate endpoint reachability information.</p>
<p>Given that such endpoints can be Kubernetes Pods, it was natural that Cilium should introduce support for BGP.</p>
<p>In this lab, you will be deploying BGP with Cilium and peer with a virtual leaf/spine data center network. By the end of the lab, you will see how easy it is to connect your data center network with your Cilium-managed Kubernetes clusters!</p>
<p>‚¨¢ BGP Support in Cilium</p>
<p>BGP support was initially introduced in Cilium 1.10 and subsequent improvements have been made since, such as the recent introduction of IPv6 support in Cilium 1.12.</p>
<p>The following video shows an introduction and a demo of the new BGP features in Cilium 1.12.</p>
<p>Get a Badge! By completing this lab, you will be able to earn a badge.</p>
<p>Make sure to finish the lab in order to get your badge!</p>
<p>Progress Tracking Hello Alan and welcome to this Isovalent hands-on lab!</p>
<p>We know labs like this one can be long, and you‚Äôre a busy person, so you might not be able to finish it in one go.</p>
<p>Don‚Äôt worry though! We‚Äôre tracking your progress through the lab, so if at any point you need to stop the lab and restart it later (or the session times out), you‚Äôll have an option to restore your progress.</p>
<p>Enjoy!</p>
<p>üèõ The Kind Cluster</p>
<p>We are going to be using Kind to set up our Kubernetes cluster, and on top of that Cilium.</p>
<p>Let‚Äôs have a look at its configuration:</p>
<p><code>yq cluster.yaml</code></p>
<div class="sourceCode" id="cb1"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="ex">root@server:~#</span> yq cluster.yaml</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="ex">kind:</span> Cluster</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="ex">name:</span> clab-bgp-cplane-demo</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="ex">apiVersion:</span> kind.x-k8s.io/v1alpha4</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="ex">networking:</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>  <span class="ex">disableDefaultCNI:</span> true</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>  <span class="ex">podSubnet:</span> <span class="st">"10.1.0.0/16"</span></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="ex">nodes:</span></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>  <span class="ex">-</span> role: control-plane</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>    <span class="ex">kubeadmConfigPatches:</span></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a>      <span class="ex">-</span> <span class="kw">|</span></span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a>        <span class="ex">kind:</span> InitConfiguration</span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a>        <span class="ex">nodeRegistration:</span></span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a>          <span class="ex">kubeletExtraArgs:</span></span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a>            <span class="ex">node-ip:</span> <span class="st">"10.0.1.2"</span></span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a>            <span class="ex">node-labels:</span> <span class="st">"rack=rack0"</span></span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a>  <span class="ex">-</span> role: worker</span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a>    <span class="ex">kubeadmConfigPatches:</span></span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a>      <span class="ex">-</span> <span class="kw">|</span></span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a>        <span class="ex">kind:</span> JoinConfiguration</span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a>        <span class="ex">nodeRegistration:</span></span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a>          <span class="ex">kubeletExtraArgs:</span></span>
<span id="cb1-23"><a href="#cb1-23" aria-hidden="true" tabindex="-1"></a>            <span class="ex">node-ip:</span> <span class="st">"10.0.2.2"</span></span>
<span id="cb1-24"><a href="#cb1-24" aria-hidden="true" tabindex="-1"></a>            <span class="ex">node-labels:</span> <span class="st">"rack=rack0"</span></span>
<span id="cb1-25"><a href="#cb1-25" aria-hidden="true" tabindex="-1"></a>  <span class="ex">-</span> role: worker</span>
<span id="cb1-26"><a href="#cb1-26" aria-hidden="true" tabindex="-1"></a>    <span class="ex">kubeadmConfigPatches:</span></span>
<span id="cb1-27"><a href="#cb1-27" aria-hidden="true" tabindex="-1"></a>      <span class="ex">-</span> <span class="kw">|</span></span>
<span id="cb1-28"><a href="#cb1-28" aria-hidden="true" tabindex="-1"></a>        <span class="ex">kind:</span> JoinConfiguration</span>
<span id="cb1-29"><a href="#cb1-29" aria-hidden="true" tabindex="-1"></a>        <span class="ex">nodeRegistration:</span></span>
<span id="cb1-30"><a href="#cb1-30" aria-hidden="true" tabindex="-1"></a>          <span class="ex">kubeletExtraArgs:</span></span>
<span id="cb1-31"><a href="#cb1-31" aria-hidden="true" tabindex="-1"></a>            <span class="ex">node-ip:</span> <span class="st">"10.0.3.2"</span></span>
<span id="cb1-32"><a href="#cb1-32" aria-hidden="true" tabindex="-1"></a>            <span class="ex">node-labels:</span> <span class="st">"rack=rack1"</span></span>
<span id="cb1-33"><a href="#cb1-33" aria-hidden="true" tabindex="-1"></a>  <span class="ex">-</span> role: worker</span>
<span id="cb1-34"><a href="#cb1-34" aria-hidden="true" tabindex="-1"></a>    <span class="ex">kubeadmConfigPatches:</span></span>
<span id="cb1-35"><a href="#cb1-35" aria-hidden="true" tabindex="-1"></a>      <span class="ex">-</span> <span class="kw">|</span></span>
<span id="cb1-36"><a href="#cb1-36" aria-hidden="true" tabindex="-1"></a>        <span class="ex">kind:</span> JoinConfiguration</span>
<span id="cb1-37"><a href="#cb1-37" aria-hidden="true" tabindex="-1"></a>        <span class="ex">nodeRegistration:</span></span>
<span id="cb1-38"><a href="#cb1-38" aria-hidden="true" tabindex="-1"></a>          <span class="ex">kubeletExtraArgs:</span></span>
<span id="cb1-39"><a href="#cb1-39" aria-hidden="true" tabindex="-1"></a>            <span class="ex">node-ip:</span> <span class="st">"10.0.4.2"</span></span>
<span id="cb1-40"><a href="#cb1-40" aria-hidden="true" tabindex="-1"></a>            <span class="ex">node-labels:</span> <span class="st">"rack=rack1"</span></span>
<span id="cb1-41"><a href="#cb1-41" aria-hidden="true" tabindex="-1"></a><span class="ex">containerdConfigPatches:</span></span>
<span id="cb1-42"><a href="#cb1-42" aria-hidden="true" tabindex="-1"></a>  <span class="ex">-</span> <span class="kw">|</span><span class="ex">-</span></span>
<span id="cb1-43"><a href="#cb1-43" aria-hidden="true" tabindex="-1"></a>    <span class="ex">[plugins.</span><span class="st">"io.containerd.grpc.v1.cri"</span><span class="ex">.registry.mirrors.</span><span class="st">"localhost:5000"</span><span class="ex">]</span></span>
<span id="cb1-44"><a href="#cb1-44" aria-hidden="true" tabindex="-1"></a>      <span class="ex">endpoint</span> = <span class="pp">[</span><span class="st">"http://kind-registry:5000"</span><span class="pp">]</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>üñ• Nodes</p>
<p>In the nodes section, you can see that the cluster consists of four nodes:</p>
<p>1 control-plane node running the Kubernetes control plane and etcd 3 worker nodes to deploy the applications</p>
<p>üîÄ Networking</p>
<p>In the networking section of the configuration file, the default CNI has been disabled so the cluster won‚Äôt have any Pod network when it starts. Instead, Cilium will be deployed to the cluster to provide this functionality.</p>
<p>To see if the Kind cluster is installed, verify that the nodes are up and joined:</p>
<p><code>kubectl get nodes</code></p>
<p>You should see the four nodes appear, all marked as NotReady. This is normal, since the CNI is disabled, and we will install Cilium later on in this lab. If you don‚Äôt see all nodes, the workers nodes might still be joining the cluster. Relaunch the command until you can see all four nodes listed.</p>
<p>Before we install Cilium on it, we will be using a platform called containerlab to simulate the networking backbone Cilium will peer with.</p>
<p>In this lab, containerlab is also responsible for assigning internal IP to the Kubernetes nodes. Notice that, if you run the following command, no IP addresses has been allocated to the nodes yet:</p>
<p><code>kubectl get nodes -o wide</code></p>
<p>That‚Äôs OK, we will be deploying containerlab in the next task.</p>
<p>üíª Networking Fabric</p>
<p>To showcase the Cilium BGP feature, we need a BGP-capable device to peer with.</p>
<p>For this purpose, we will be leveraging Containerlab and FRR (Free Range Routing). These great tools provide the ability to simulate networking environment in containers.</p>
<p>üß™ Containerlab</p>
<p>Containerlab is a platform that enables users to deploy virtual networking topologies, based on containers and virtual machines. One of the virtual routing appliances that can be deployed via Containerlab is FRR - a feature-rich open-source networking platform.</p>
<p>By the end of the lab, you will have established BGP peering with the FRR virtual devices.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="image.png" class="img-fluid figure-img"></p>
<figcaption>alt text</figcaption>
</figure>
</div>
<p>üîç Inspect the network topology (Optional) If you‚Äôre curious, you can check out in details the containerlab topology we are deploying as part of the lab.</p>
<p><code>yq topo.yaml</code></p>
<div class="sourceCode" id="cb2"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="ex">name:</span> bgp-cplane-demo</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="ex">topology:</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>  <span class="ex">kinds:</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>    <span class="ex">linux:</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>      <span class="ex">cmd:</span> bash</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>  <span class="ex">nodes:</span></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>    <span class="ex">router0:</span></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>      <span class="ex">kind:</span> linux</span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>      <span class="ex">image:</span> frrouting/frr:v8.2.2</span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>      <span class="ex">labels:</span></span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>        <span class="ex">app:</span> frr</span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>      <span class="ex">exec:</span></span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a>        <span class="co"># NAT everything in here to go outside of the lab</span></span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a>        <span class="ex">-</span> iptables <span class="at">-t</span> nat <span class="at">-A</span> POSTROUTING <span class="at">-o</span> eth0 <span class="at">-j</span> MASQUERADE</span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Loopback IP (IP address of the router itself)</span></span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a>        <span class="ex">-</span> ip addr add 10.0.0.0/32 dev lo</span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Terminate rest of the 10.0.0.0/8 in here</span></span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a>        <span class="ex">-</span> ip route add blackhole 10.0.0.0/8</span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Boiler plate to make FRR work</span></span>
<span id="cb2-20"><a href="#cb2-20" aria-hidden="true" tabindex="-1"></a>        <span class="ex">-</span> touch /etc/frr/vtysh.conf</span>
<span id="cb2-21"><a href="#cb2-21" aria-hidden="true" tabindex="-1"></a>        <span class="ex">-</span> sed <span class="at">-i</span> <span class="at">-e</span> <span class="st">'s/bgpd=no/bgpd=yes/g'</span> /etc/frr/daemons</span>
<span id="cb2-22"><a href="#cb2-22" aria-hidden="true" tabindex="-1"></a>        <span class="ex">-</span> /usr/lib/frr/frrinit.sh start</span>
<span id="cb2-23"><a href="#cb2-23" aria-hidden="true" tabindex="-1"></a>        <span class="co"># FRR configuration</span></span>
<span id="cb2-24"><a href="#cb2-24" aria-hidden="true" tabindex="-1"></a>        <span class="ex">-</span> <span class="op">&gt;</span>-</span>
<span id="cb2-25"><a href="#cb2-25" aria-hidden="true" tabindex="-1"></a>          <span class="ex">vtysh</span> <span class="at">-c</span> <span class="st">'conf t'</span> <span class="at">-c</span> <span class="st">'frr defaults datacenter'</span> <span class="at">-c</span> <span class="st">'router bgp 65000'</span> <span class="at">-c</span> <span class="st">'  bgp router-id 10.0.0.0'</span> <span class="at">-c</span> <span class="st">'  no bgp ebgp-requires-policy'</span> <span class="at">-c</span> <span class="st">'  neighbor ROUTERS peer-group'</span> <span class="at">-c</span> <span class="st">'  neighbor ROUTERS remote-as external'</span> <span class="at">-c</span> <span class="st">'  neighbor ROUTERS default-originate'</span> <span class="at">-c</span> <span class="st">'  neighbor net0 interface peer-group ROUTERS'</span> <span class="at">-c</span> <span class="st">'  neighbor net1 interface peer-group ROUTERS'</span> <span class="at">-c</span> <span class="st">'  address-family ipv4 unicast'</span> <span class="at">-c</span> <span class="st">'    redistribute connected'</span> <span class="at">-c</span> <span class="st">'  exit-address-family'</span> <span class="at">-c</span> <span class="st">'!'</span></span>
<span id="cb2-26"><a href="#cb2-26" aria-hidden="true" tabindex="-1"></a>    <span class="ex">tor0:</span></span>
<span id="cb2-27"><a href="#cb2-27" aria-hidden="true" tabindex="-1"></a>      <span class="ex">kind:</span> linux</span>
<span id="cb2-28"><a href="#cb2-28" aria-hidden="true" tabindex="-1"></a>      <span class="ex">image:</span> frrouting/frr:v8.2.2</span>
<span id="cb2-29"><a href="#cb2-29" aria-hidden="true" tabindex="-1"></a>      <span class="ex">labels:</span></span>
<span id="cb2-30"><a href="#cb2-30" aria-hidden="true" tabindex="-1"></a>        <span class="ex">app:</span> frr</span>
<span id="cb2-31"><a href="#cb2-31" aria-hidden="true" tabindex="-1"></a>      <span class="ex">exec:</span></span>
<span id="cb2-32"><a href="#cb2-32" aria-hidden="true" tabindex="-1"></a>        <span class="ex">-</span> ip link del eth0</span>
<span id="cb2-33"><a href="#cb2-33" aria-hidden="true" tabindex="-1"></a>        <span class="ex">-</span> ip addr add 10.0.0.1/32 dev lo</span>
<span id="cb2-34"><a href="#cb2-34" aria-hidden="true" tabindex="-1"></a>        <span class="ex">-</span> ip addr add 10.0.1.1/24 dev net1</span>
<span id="cb2-35"><a href="#cb2-35" aria-hidden="true" tabindex="-1"></a>        <span class="ex">-</span> ip addr add 10.0.2.1/24 dev net2</span>
<span id="cb2-36"><a href="#cb2-36" aria-hidden="true" tabindex="-1"></a>        <span class="ex">-</span> touch /etc/frr/vtysh.conf</span>
<span id="cb2-37"><a href="#cb2-37" aria-hidden="true" tabindex="-1"></a>        <span class="ex">-</span> sed <span class="at">-i</span> <span class="at">-e</span> <span class="st">'s/bgpd=no/bgpd=yes/g'</span> /etc/frr/daemons</span>
<span id="cb2-38"><a href="#cb2-38" aria-hidden="true" tabindex="-1"></a>        <span class="ex">-</span> /usr/lib/frr/frrinit.sh start</span>
<span id="cb2-39"><a href="#cb2-39" aria-hidden="true" tabindex="-1"></a>        <span class="ex">-</span> <span class="op">&gt;</span>-</span>
<span id="cb2-40"><a href="#cb2-40" aria-hidden="true" tabindex="-1"></a>          <span class="ex">vtysh</span> <span class="at">-c</span> <span class="st">'conf t'</span> <span class="at">-c</span> <span class="st">'frr defaults datacenter'</span> <span class="at">-c</span> <span class="st">'router bgp 65010'</span> <span class="at">-c</span> <span class="st">'  bgp router-id 10.0.0.1'</span> <span class="at">-c</span> <span class="st">'  no bgp ebgp-requires-policy'</span> <span class="at">-c</span> <span class="st">'  neighbor ROUTERS peer-group'</span> <span class="at">-c</span> <span class="st">'  neighbor ROUTERS remote-as external'</span> <span class="at">-c</span> <span class="st">'  neighbor SERVERS peer-group'</span> <span class="at">-c</span> <span class="st">'  neighbor SERVERS remote-as internal'</span> <span class="at">-c</span> <span class="st">'  neighbor net0 interface peer-group ROUTERS'</span> <span class="at">-c</span> <span class="st">'  neighbor 10.0.1.2 peer-group SERVERS'</span> <span class="at">-c</span> <span class="st">'  neighbor 10.0.2.2 peer-group SERVERS'</span> <span class="at">-c</span> <span class="st">'  address-family ipv4 unicast'</span> <span class="at">-c</span> <span class="st">'    redistribute connected'</span> <span class="at">-c</span> <span class="st">'  exit-address-family'</span> <span class="at">-c</span> <span class="st">'!'</span></span>
<span id="cb2-41"><a href="#cb2-41" aria-hidden="true" tabindex="-1"></a>    <span class="ex">tor1:</span></span>
<span id="cb2-42"><a href="#cb2-42" aria-hidden="true" tabindex="-1"></a>      <span class="ex">kind:</span> linux</span>
<span id="cb2-43"><a href="#cb2-43" aria-hidden="true" tabindex="-1"></a>      <span class="ex">image:</span> frrouting/frr:v8.2.2</span>
<span id="cb2-44"><a href="#cb2-44" aria-hidden="true" tabindex="-1"></a>      <span class="ex">labels:</span></span>
<span id="cb2-45"><a href="#cb2-45" aria-hidden="true" tabindex="-1"></a>        <span class="ex">app:</span> frr</span>
<span id="cb2-46"><a href="#cb2-46" aria-hidden="true" tabindex="-1"></a>      <span class="ex">exec:</span></span>
<span id="cb2-47"><a href="#cb2-47" aria-hidden="true" tabindex="-1"></a>        <span class="ex">-</span> ip link del eth0</span>
<span id="cb2-48"><a href="#cb2-48" aria-hidden="true" tabindex="-1"></a>        <span class="ex">-</span> ip addr add 10.0.0.2/32 dev lo</span>
<span id="cb2-49"><a href="#cb2-49" aria-hidden="true" tabindex="-1"></a>        <span class="ex">-</span> ip addr add 10.0.3.1/24 dev net1</span>
<span id="cb2-50"><a href="#cb2-50" aria-hidden="true" tabindex="-1"></a>        <span class="ex">-</span> ip addr add 10.0.4.1/24 dev net2</span>
<span id="cb2-51"><a href="#cb2-51" aria-hidden="true" tabindex="-1"></a>        <span class="ex">-</span> touch /etc/frr/vtysh.conf</span>
<span id="cb2-52"><a href="#cb2-52" aria-hidden="true" tabindex="-1"></a>        <span class="ex">-</span> sed <span class="at">-i</span> <span class="at">-e</span> <span class="st">'s/bgpd=no/bgpd=yes/g'</span> /etc/frr/daemons</span>
<span id="cb2-53"><a href="#cb2-53" aria-hidden="true" tabindex="-1"></a>        <span class="ex">-</span> /usr/lib/frr/frrinit.sh start</span>
<span id="cb2-54"><a href="#cb2-54" aria-hidden="true" tabindex="-1"></a>        <span class="ex">-</span> <span class="op">&gt;</span>-</span>
<span id="cb2-55"><a href="#cb2-55" aria-hidden="true" tabindex="-1"></a>          <span class="ex">vtysh</span> <span class="at">-c</span> <span class="st">'conf t'</span> <span class="at">-c</span> <span class="st">'frr defaults datacenter'</span> <span class="at">-c</span> <span class="st">'router bgp 65011'</span> <span class="at">-c</span> <span class="st">'  bgp router-id 10.0.0.2'</span> <span class="at">-c</span> <span class="st">'  bgp bestpath as-path multipath-relax'</span> <span class="at">-c</span> <span class="st">'  no bgp ebgp-requires-policy'</span> <span class="at">-c</span> <span class="st">'  neighbor ROUTERS peer-group'</span> <span class="at">-c</span> <span class="st">'  neighbor ROUTERS remote-as external'</span> <span class="at">-c</span> <span class="st">'  neighbor SERVERS peer-group'</span> <span class="at">-c</span> <span class="st">'  neighbor SERVERS remote-as internal'</span> <span class="at">-c</span> <span class="st">'  neighbor net0 interface peer-group ROUTERS'</span> <span class="at">-c</span> <span class="st">'  neighbor 10.0.3.2 peer-group SERVERS'</span> <span class="at">-c</span> <span class="st">'  neighbor 10.0.4.2 peer-group SERVERS'</span> <span class="at">-c</span> <span class="st">'  address-family ipv4 unicast'</span> <span class="at">-c</span> <span class="st">'    redistribute connected'</span> <span class="at">-c</span> <span class="st">'  exit-address-family'</span> <span class="at">-c</span> <span class="st">'!'</span></span>
<span id="cb2-56"><a href="#cb2-56" aria-hidden="true" tabindex="-1"></a>    <span class="ex">srv-control-plane:</span></span>
<span id="cb2-57"><a href="#cb2-57" aria-hidden="true" tabindex="-1"></a>      <span class="ex">kind:</span> linux</span>
<span id="cb2-58"><a href="#cb2-58" aria-hidden="true" tabindex="-1"></a>      <span class="ex">image:</span> nicolaka/netshoot:latest</span>
<span id="cb2-59"><a href="#cb2-59" aria-hidden="true" tabindex="-1"></a>      <span class="ex">network-mode:</span> container:control-plane</span>
<span id="cb2-60"><a href="#cb2-60" aria-hidden="true" tabindex="-1"></a>      <span class="ex">exec:</span></span>
<span id="cb2-61"><a href="#cb2-61" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Cilium currently doesn't support BGP Unnumbered</span></span>
<span id="cb2-62"><a href="#cb2-62" aria-hidden="true" tabindex="-1"></a>        <span class="ex">-</span> ip addr add 10.0.1.2/24 dev net0</span>
<span id="cb2-63"><a href="#cb2-63" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Cilium currently doesn't support importing routes</span></span>
<span id="cb2-64"><a href="#cb2-64" aria-hidden="true" tabindex="-1"></a>        <span class="ex">-</span> ip route replace default via 10.0.1.1</span>
<span id="cb2-65"><a href="#cb2-65" aria-hidden="true" tabindex="-1"></a>    <span class="ex">srv-worker:</span></span>
<span id="cb2-66"><a href="#cb2-66" aria-hidden="true" tabindex="-1"></a>      <span class="ex">kind:</span> linux</span>
<span id="cb2-67"><a href="#cb2-67" aria-hidden="true" tabindex="-1"></a>      <span class="ex">image:</span> nicolaka/netshoot:latest</span>
<span id="cb2-68"><a href="#cb2-68" aria-hidden="true" tabindex="-1"></a>      <span class="ex">network-mode:</span> container:worker</span>
<span id="cb2-69"><a href="#cb2-69" aria-hidden="true" tabindex="-1"></a>      <span class="ex">exec:</span></span>
<span id="cb2-70"><a href="#cb2-70" aria-hidden="true" tabindex="-1"></a>        <span class="ex">-</span> ip addr add 10.0.2.2/24 dev net0</span>
<span id="cb2-71"><a href="#cb2-71" aria-hidden="true" tabindex="-1"></a>        <span class="ex">-</span> ip route replace default via 10.0.2.1</span>
<span id="cb2-72"><a href="#cb2-72" aria-hidden="true" tabindex="-1"></a>    <span class="ex">srv-worker2:</span></span>
<span id="cb2-73"><a href="#cb2-73" aria-hidden="true" tabindex="-1"></a>      <span class="ex">kind:</span> linux</span>
<span id="cb2-74"><a href="#cb2-74" aria-hidden="true" tabindex="-1"></a>      <span class="ex">image:</span> nicolaka/netshoot:latest</span>
<span id="cb2-75"><a href="#cb2-75" aria-hidden="true" tabindex="-1"></a>      <span class="ex">network-mode:</span> container:worker2</span>
<span id="cb2-76"><a href="#cb2-76" aria-hidden="true" tabindex="-1"></a>      <span class="ex">exec:</span></span>
<span id="cb2-77"><a href="#cb2-77" aria-hidden="true" tabindex="-1"></a>        <span class="ex">-</span> ip addr add 10.0.3.2/24 dev net0</span>
<span id="cb2-78"><a href="#cb2-78" aria-hidden="true" tabindex="-1"></a>        <span class="ex">-</span> ip route replace default via 10.0.3.1</span>
<span id="cb2-79"><a href="#cb2-79" aria-hidden="true" tabindex="-1"></a>    <span class="ex">srv-worker3:</span></span>
<span id="cb2-80"><a href="#cb2-80" aria-hidden="true" tabindex="-1"></a>      <span class="ex">kind:</span> linux</span>
<span id="cb2-81"><a href="#cb2-81" aria-hidden="true" tabindex="-1"></a>      <span class="ex">image:</span> nicolaka/netshoot:latest</span>
<span id="cb2-82"><a href="#cb2-82" aria-hidden="true" tabindex="-1"></a>      <span class="ex">network-mode:</span> container:worker3</span>
<span id="cb2-83"><a href="#cb2-83" aria-hidden="true" tabindex="-1"></a>      <span class="ex">exec:</span></span>
<span id="cb2-84"><a href="#cb2-84" aria-hidden="true" tabindex="-1"></a>        <span class="ex">-</span> ip addr add 10.0.4.2/24 dev net0</span>
<span id="cb2-85"><a href="#cb2-85" aria-hidden="true" tabindex="-1"></a>        <span class="ex">-</span> ip route replace default via 10.0.4.1</span>
<span id="cb2-86"><a href="#cb2-86" aria-hidden="true" tabindex="-1"></a>  <span class="ex">links:</span></span>
<span id="cb2-87"><a href="#cb2-87" aria-hidden="true" tabindex="-1"></a>    <span class="ex">-</span> endpoints: [<span class="st">"router0:net0"</span>, <span class="st">"tor0:net0"</span>]</span>
<span id="cb2-88"><a href="#cb2-88" aria-hidden="true" tabindex="-1"></a>    <span class="ex">-</span> endpoints: [<span class="st">"router0:net1"</span>, <span class="st">"tor1:net0"</span>]</span>
<span id="cb2-89"><a href="#cb2-89" aria-hidden="true" tabindex="-1"></a>    <span class="ex">-</span> endpoints: [<span class="st">"tor0:net1"</span>, <span class="st">"srv-control-plane:net0"</span>]</span>
<span id="cb2-90"><a href="#cb2-90" aria-hidden="true" tabindex="-1"></a>    <span class="ex">-</span> endpoints: [<span class="st">"tor0:net2"</span>, <span class="st">"srv-worker:net0"</span>]</span>
<span id="cb2-91"><a href="#cb2-91" aria-hidden="true" tabindex="-1"></a>    <span class="ex">-</span> endpoints: [<span class="st">"tor1:net1"</span>, <span class="st">"srv-worker2:net0"</span>]</span>
<span id="cb2-92"><a href="#cb2-92" aria-hidden="true" tabindex="-1"></a>    <span class="ex">-</span> endpoints: [<span class="st">"tor1:net2"</span>, <span class="st">"srv-worker3:net0"</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Go to the üîó üó∫Ô∏è Network Topology tab to observe the architecture.</p>
<p>The main thing to notice is that we are deploying 3 main routing nodes: a backbone router (router0) and two Top of Rack (ToR) routers (tor0 and tor1). We are pre-configuring them at boot time with their IP and BGP configuration. At the end of the YAML file, you will also note we are establishing virtual links between the backbone and the ToR routers.</p>
<p>In the following tasks, we will configure Cilium to run BGP on the kind nodes and to establish BGP peering with the ToR devices.</p>
<p>Here is what the overall final topology looks like (note you can resize this window if the diagram is too small):</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="image-1.png" class="img-fluid figure-img"></p>
<figcaption>alt text</figcaption>
</figure>
</div>
<p>üöÄ Deploy the networking topology</p>
<p>In the &gt;_ Terminal, deploy the topology previously described:</p>
<p><code>containerlab -t topo.yaml deploy</code></p>
<p>This typically only takes a few seconds to deploy.</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="va">INFO</span><span class="op">[</span><span class="dv">0000</span><span class="op">]</span> <span class="ex">Containerlab</span> v0.31.1 started</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="va">INFO</span><span class="op">[</span><span class="dv">0000</span><span class="op">]</span> <span class="ex">Parsing</span> <span class="kw">&amp;</span> <span class="ex">checking</span> topology file: topo.yaml</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a><span class="va">INFO</span><span class="op">[</span><span class="dv">0000</span><span class="op">]</span> <span class="ex">Could</span> not read docker config: open /root/.docker/config.json: no such file or directory</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a><span class="va">INFO</span><span class="op">[</span><span class="dv">0000</span><span class="op">]</span> <span class="ex">Pulling</span> docker.io/frrouting/frr:v8.2.2 Docker image</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a><span class="va">INFO</span><span class="op">[</span><span class="dv">0004</span><span class="op">]</span> <span class="ex">Done</span> pulling docker.io/frrouting/frr:v8.2.2</span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a><span class="va">INFO</span><span class="op">[</span><span class="dv">0004</span><span class="op">]</span> <span class="ex">Could</span> not read docker config: open /root/.docker/config.json: no such file or directory</span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a><span class="va">INFO</span><span class="op">[</span><span class="dv">0004</span><span class="op">]</span> <span class="ex">Pulling</span> docker.io/nicolaka/netshoot:latest Docker image</span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a><span class="va">INFO</span><span class="op">[</span><span class="dv">0016</span><span class="op">]</span> <span class="ex">Done</span> pulling docker.io/nicolaka/netshoot:latest</span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a><span class="va">INFO</span><span class="op">[</span><span class="dv">0016</span><span class="op">]</span> <span class="ex">Creating</span> lab directory: /root/clab-bgp-cplane-demo</span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a><span class="va">INFO</span><span class="op">[</span><span class="dv">0016</span><span class="op">]</span> <span class="ex">Creating</span> docker network: Name=<span class="st">"clab"</span>, IPv4Subnet=<span class="st">"172.20.20.0/24"</span>, IPv6Subnet=<span class="st">"2001:172:20:20::/64"</span>, MTU=<span class="st">"1500"</span></span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a><span class="va">INFO</span><span class="op">[</span><span class="dv">0016</span><span class="op">]</span> <span class="ex">Creating</span> container: <span class="st">"srv-worker"</span></span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a><span class="va">INFO</span><span class="op">[</span><span class="dv">0016</span><span class="op">]</span> <span class="ex">Creating</span> container: <span class="st">"srv-control-plane"</span></span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a><span class="va">INFO</span><span class="op">[</span><span class="dv">0016</span><span class="op">]</span> <span class="ex">Creating</span> container: <span class="st">"tor0"</span></span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a><span class="va">INFO</span><span class="op">[</span><span class="dv">0016</span><span class="op">]</span> <span class="ex">Creating</span> container: <span class="st">"router0"</span></span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a><span class="va">INFO</span><span class="op">[</span><span class="dv">0016</span><span class="op">]</span> <span class="ex">Creating</span> container: <span class="st">"tor1"</span></span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a><span class="va">INFO</span><span class="op">[</span><span class="dv">0016</span><span class="op">]</span> <span class="ex">Creating</span> container: <span class="st">"srv-worker3"</span></span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a><span class="va">INFO</span><span class="op">[</span><span class="dv">0016</span><span class="op">]</span> <span class="ex">Creating</span> container: <span class="st">"srv-worker2"</span></span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true" tabindex="-1"></a><span class="va">INFO</span><span class="op">[</span><span class="dv">0019</span><span class="op">]</span> <span class="ex">Creating</span> virtual wire: router0:net0 <span class="op">&lt;</span>--<span class="op">&gt;</span> tor0:net0</span>
<span id="cb3-19"><a href="#cb3-19" aria-hidden="true" tabindex="-1"></a><span class="va">INFO</span><span class="op">[</span><span class="dv">0019</span><span class="op">]</span> <span class="ex">Creating</span> virtual wire: tor0:net1 <span class="op">&lt;</span>--<span class="op">&gt;</span> srv-control-plane:net0</span>
<span id="cb3-20"><a href="#cb3-20" aria-hidden="true" tabindex="-1"></a><span class="va">INFO</span><span class="op">[</span><span class="dv">0019</span><span class="op">]</span> <span class="ex">Creating</span> virtual wire: tor0:net2 <span class="op">&lt;</span>--<span class="op">&gt;</span> srv-worker:net0</span>
<span id="cb3-21"><a href="#cb3-21" aria-hidden="true" tabindex="-1"></a><span class="va">INFO</span><span class="op">[</span><span class="dv">0019</span><span class="op">]</span> <span class="ex">Creating</span> virtual wire: tor1:net1 <span class="op">&lt;</span>--<span class="op">&gt;</span> srv-worker2:net0</span>
<span id="cb3-22"><a href="#cb3-22" aria-hidden="true" tabindex="-1"></a><span class="va">INFO</span><span class="op">[</span><span class="dv">0019</span><span class="op">]</span> <span class="ex">Creating</span> virtual wire: router0:net1 <span class="op">&lt;</span>--<span class="op">&gt;</span> tor1:net0</span>
<span id="cb3-23"><a href="#cb3-23" aria-hidden="true" tabindex="-1"></a><span class="va">INFO</span><span class="op">[</span><span class="dv">0019</span><span class="op">]</span> <span class="ex">Creating</span> virtual wire: tor1:net2 <span class="op">&lt;</span>--<span class="op">&gt;</span> srv-worker3:net0</span>
<span id="cb3-24"><a href="#cb3-24" aria-hidden="true" tabindex="-1"></a><span class="va">INFO</span><span class="op">[</span><span class="dv">0019</span><span class="op">]</span> <span class="ex">Adding</span> containerlab host entries to /etc/hosts file</span>
<span id="cb3-25"><a href="#cb3-25" aria-hidden="true" tabindex="-1"></a><span class="va">INFO</span><span class="op">[</span><span class="dv">0020</span><span class="op">]</span> <span class="ex">Executed</span> command <span class="st">'/usr/lib/frr/frrinit.sh start'</span> on clab-bgp-cplane-demo-tor1. stdout:</span>
<span id="cb3-26"><a href="#cb3-26" aria-hidden="true" tabindex="-1"></a><span class="ex">Started</span> watchfrr</span>
<span id="cb3-27"><a href="#cb3-27" aria-hidden="true" tabindex="-1"></a><span class="va">INFO</span><span class="op">[</span><span class="dv">0021</span><span class="op">]</span> <span class="ex">Executed</span> command <span class="st">'/usr/lib/frr/frrinit.sh start'</span> on clab-bgp-cplane-demo-router0. stdout:</span>
<span id="cb3-28"><a href="#cb3-28" aria-hidden="true" tabindex="-1"></a><span class="ex">Started</span> watchfrr</span>
<span id="cb3-29"><a href="#cb3-29" aria-hidden="true" tabindex="-1"></a><span class="va">INFO</span><span class="op">[</span><span class="dv">0022</span><span class="op">]</span> <span class="ex">Executed</span> command <span class="st">'/usr/lib/frr/frrinit.sh start'</span> on clab-bgp-cplane-demo-tor0. stdout:</span>
<span id="cb3-30"><a href="#cb3-30" aria-hidden="true" tabindex="-1"></a><span class="ex">Started</span> watchfrr</span>
<span id="cb3-31"><a href="#cb3-31" aria-hidden="true" tabindex="-1"></a><span class="va">INFO</span><span class="op">[</span><span class="dv">0022</span><span class="op">]</span> <span class="ex">üéâ</span> New containerlab version 0.54.2 is available! Release notes: https://containerlab.dev/rn/0.54/#0542</span>
<span id="cb3-32"><a href="#cb3-32" aria-hidden="true" tabindex="-1"></a><span class="ex">Run</span> <span class="st">'containerlab version upgrade'</span> to upgrade or go check other installation options at https://containerlab.dev/install/</span>
<span id="cb3-33"><a href="#cb3-33" aria-hidden="true" tabindex="-1"></a><span class="ex">+---+----------------------------------------+--------------+--------------------------+-------+---------+----------------+----------------------+</span></span>
<span id="cb3-34"><a href="#cb3-34" aria-hidden="true" tabindex="-1"></a><span class="kw">|</span> <span class="co"># |                  Name                  | Container ID |          Image           | Kind  |  State  |  IPv4 Address  |     IPv6 Address     |</span></span>
<span id="cb3-35"><a href="#cb3-35" aria-hidden="true" tabindex="-1"></a><span class="ex">+---+----------------------------------------+--------------+--------------------------+-------+---------+----------------+----------------------+</span></span>
<span id="cb3-36"><a href="#cb3-36" aria-hidden="true" tabindex="-1"></a><span class="kw">|</span> <span class="ex">1</span> <span class="kw">|</span> <span class="ex">clab-bgp-cplane-demo-router0</span>           <span class="kw">|</span> <span class="ex">258f32563375</span> <span class="kw">|</span> <span class="ex">frrouting/frr:v8.2.2</span>     <span class="kw">|</span> <span class="ex">linux</span> <span class="kw">|</span> <span class="ex">running</span> <span class="kw">|</span> <span class="ex">172.20.20.2/24</span> <span class="kw">|</span> <span class="ex">2001:172:20:20::2/64</span> <span class="kw">|</span></span>
<span id="cb3-37"><a href="#cb3-37" aria-hidden="true" tabindex="-1"></a><span class="kw">|</span> <span class="ex">2</span> <span class="kw">|</span> <span class="ex">clab-bgp-cplane-demo-srv-control-plane</span> <span class="kw">|</span> <span class="ex">45d72191a144</span> <span class="kw">|</span> <span class="ex">nicolaka/netshoot:latest</span> <span class="kw">|</span> <span class="ex">linux</span> <span class="kw">|</span> <span class="ex">running</span> <span class="kw">|</span> <span class="ex">N/A</span>            <span class="kw">|</span> <span class="ex">N/A</span>                  <span class="kw">|</span></span>
<span id="cb3-38"><a href="#cb3-38" aria-hidden="true" tabindex="-1"></a><span class="kw">|</span> <span class="ex">3</span> <span class="kw">|</span> <span class="ex">clab-bgp-cplane-demo-srv-worker</span>        <span class="kw">|</span> <span class="ex">4fc966b2a876</span> <span class="kw">|</span> <span class="ex">nicolaka/netshoot:latest</span> <span class="kw">|</span> <span class="ex">linux</span> <span class="kw">|</span> <span class="ex">running</span> <span class="kw">|</span> <span class="ex">N/A</span>            <span class="kw">|</span> <span class="ex">N/A</span>                  <span class="kw">|</span></span>
<span id="cb3-39"><a href="#cb3-39" aria-hidden="true" tabindex="-1"></a><span class="kw">|</span> <span class="ex">4</span> <span class="kw">|</span> <span class="ex">clab-bgp-cplane-demo-srv-worker2</span>       <span class="kw">|</span> <span class="ex">00ec5fe012ff</span> <span class="kw">|</span> <span class="ex">nicolaka/netshoot:latest</span> <span class="kw">|</span> <span class="ex">linux</span> <span class="kw">|</span> <span class="ex">running</span> <span class="kw">|</span> <span class="ex">N/A</span>            <span class="kw">|</span> <span class="ex">N/A</span>                  <span class="kw">|</span></span>
<span id="cb3-40"><a href="#cb3-40" aria-hidden="true" tabindex="-1"></a><span class="kw">|</span> <span class="ex">5</span> <span class="kw">|</span> <span class="ex">clab-bgp-cplane-demo-srv-worker3</span>       <span class="kw">|</span> <span class="ex">6c89b592b297</span> <span class="kw">|</span> <span class="ex">nicolaka/netshoot:latest</span> <span class="kw">|</span> <span class="ex">linux</span> <span class="kw">|</span> <span class="ex">running</span> <span class="kw">|</span> <span class="ex">N/A</span>            <span class="kw">|</span> <span class="ex">N/A</span>                  <span class="kw">|</span></span>
<span id="cb3-41"><a href="#cb3-41" aria-hidden="true" tabindex="-1"></a><span class="kw">|</span> <span class="ex">6</span> <span class="kw">|</span> <span class="ex">clab-bgp-cplane-demo-tor0</span>              <span class="kw">|</span> <span class="ex">f4680ddb95d3</span> <span class="kw">|</span> <span class="ex">frrouting/frr:v8.2.2</span>     <span class="kw">|</span> <span class="ex">linux</span> <span class="kw">|</span> <span class="ex">running</span> <span class="kw">|</span> <span class="ex">172.20.20.4/24</span> <span class="kw">|</span> <span class="ex">2001:172:20:20::4/64</span> <span class="kw">|</span></span>
<span id="cb3-42"><a href="#cb3-42" aria-hidden="true" tabindex="-1"></a><span class="kw">|</span> <span class="ex">7</span> <span class="kw">|</span> <span class="ex">clab-bgp-cplane-demo-tor1</span>              <span class="kw">|</span> <span class="ex">ce203d83dd09</span> <span class="kw">|</span> <span class="ex">frrouting/frr:v8.2.2</span>     <span class="kw">|</span> <span class="ex">linux</span> <span class="kw">|</span> <span class="ex">running</span> <span class="kw">|</span> <span class="ex">172.20.20.3/24</span> <span class="kw">|</span> <span class="ex">2001:172:20:20::3/64</span> <span class="kw">|</span></span>
<span id="cb3-43"><a href="#cb3-43" aria-hidden="true" tabindex="-1"></a><span class="ex">+---+----------------------------------------+--------------+--------------------------+-------+---------+----------------+----------------------+</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>‚úÖ Verify our connectivity</p>
<p>At this stage, BGP should be up between our Top of Rack switches and the backbone router router0.</p>
<p>Topology <img src="image-2.png" class="img-fluid" alt="alt text"></p>
<p>Let‚Äôs verify this with this command.</p>
<p><code>docker exec -it clab-bgp-cplane-demo-router0 vtysh -c 'show bgp ipv4 summary wide'</code></p>
<div class="sourceCode" id="cb4"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="ex">root@server:~#</span> docker exec <span class="at">-it</span> clab-bgp-cplane-demo-router0 vtysh <span class="at">-c</span> <span class="st">'show bgp ipv4 summary wide'</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a><span class="ex">IPv4</span> Unicast Summary <span class="er">(</span><span class="ex">VRF</span> default<span class="kw">)</span><span class="bu">:</span></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a><span class="ex">BGP</span> router identifier 10.0.0.0, local AS number 65000 vrf-id 0</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a><span class="ex">BGP</span> table version 8</span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a><span class="ex">RIB</span> entries 15, using 2760 bytes of memory</span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a><span class="ex">Peers</span> 2, using 1433 KiB of memory</span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a><span class="ex">Peer</span> groups 1, using 64 bytes of memory</span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a><span class="ex">Neighbor</span>        V         AS    LocalAS   MsgRcvd   MsgSent   TblVer  InQ OutQ  Up/Down State/PfxRcd   PfxSnt Desc</span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a><span class="ex">tor0</span><span class="er">(</span><span class="ex">net0</span><span class="kw">)</span>      <span class="ex">4</span>      65010      65000        28        28        0    0    0 00:00:57            3        9 N/A</span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a><span class="ex">tor1</span><span class="er">(</span><span class="ex">net1</span><span class="kw">)</span>      <span class="ex">4</span>      65011      65000        28        28        0    0    0 00:00:57            3        9 N/A</span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a><span class="ex">Total</span> number of neighbors 2</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Let‚Äôs explain briefly this command.</p>
<p>docker exec -it lets us enter the router0 shell. As mentioned earlier, router0 is based on the open-source Free Range Routing platform (FRR). vtysh is the integrated shell on FRR devices. show bgp ipv4 summary wide lets us check the BGP status. Once you run this command, you will an output such as:</p>
<p>IPv4 Unicast Summary (VRF default): BGP router identifier 10.0.0.0, local AS number 65000 vrf-id 0</p>
<p>Neighbor V AS LocalAS MsgRcvd MsgSent TblVer InQ OutQ Up/Down State/PfxRcd PfxSnt Desc tor0(net0) 4 65010 65000 42 41 0 0 0 00:01:42 3 9 N/A tor1(net1) 4 65011 65000 42 42 0 0 0 00:01:41 3 9 N/A</p>
<p>Total number of neighbors 2 If you‚Äôre familiar with using BGP on traditional CLIs such as Cisco IOS, this will look familiar. If not, let‚Äôs go through some of the key outputs of the command above.</p>
<p>This commands provides information about the BGP status on router0. It shows router0‚Äôs local AS number (65000), the remote AS number of the routers it is peering with (65010 for tor0 and 65011 for tor1).</p>
<p>It also shows, in the Up/Down column where the session is established (if that‚Äôs the case, it will show for how long the session has been up - in our case, it‚Äôs been up for 00:01:41).</p>
<p>Finally, it shows how many prefixes have been received and sent (see State/PfxRcd and PfxSnt).</p>
<p>Let‚Äôs run this command on the Top of Rack switches. Two of the sessions remain ‚ÄúActive‚Äù - it means the peering sessions are configured and actively trying to peer but they are not established yet.</p>
<p>It‚Äôs to be expected: BGP is not established with the Kind nodes as we haven‚Äôt deployed Cilium yet.</p>
<p>On tor0:</p>
<p><code>docker exec -it clab-bgp-cplane-demo-tor0 vtysh -c 'show bgp ipv4 summary wide'</code></p>
<div class="sourceCode" id="cb5"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="ex">root@server:~#</span> docker exec <span class="at">-it</span> clab-bgp-cplane-demo-tor0 vtysh <span class="at">-c</span> <span class="st">'show bgp ipv4 summary wide'</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a><span class="ex">IPv4</span> Unicast Summary <span class="er">(</span><span class="ex">VRF</span> default<span class="kw">)</span><span class="bu">:</span></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a><span class="ex">BGP</span> router identifier 10.0.0.1, local AS number 65010 vrf-id 0</span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a><span class="ex">BGP</span> table version 9</span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a><span class="ex">RIB</span> entries 15, using 2760 bytes of memory</span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a><span class="ex">Peers</span> 3, using 2149 KiB of memory</span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a><span class="ex">Peer</span> groups 2, using 128 bytes of memory</span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a><span class="ex">Neighbor</span>        V         AS    LocalAS   MsgRcvd   MsgSent   TblVer  InQ OutQ  Up/Down State/PfxRcd   PfxSnt Desc</span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a><span class="ex">router0</span><span class="er">(</span><span class="ex">net0</span><span class="kw">)</span>   <span class="ex">4</span>      65000      65010        38        39        0    0    0 00:01:32            6        9 N/A</span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a><span class="ex">10.0.1.2</span>        4          0      65010         0         0        0    0    0    never       Active        0 N/A</span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a><span class="ex">10.0.2.2</span>        4          0      65010         0         0        0    0    0    never       Active        0 N/A</span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a><span class="ex">Total</span> number of neighbors 3</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>On tor1:</p>
<p><code>docker exec -it clab-bgp-cplane-demo-tor1 vtysh -c 'show bgp ipv4 summary wide'</code></p>
<div class="sourceCode" id="cb6"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="ex">root@server:~#</span> docker exec <span class="at">-it</span> clab-bgp-cplane-demo-tor1 vtysh <span class="at">-c</span> <span class="st">'show bgp ipv4 summary wide'</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a><span class="ex">IPv4</span> Unicast Summary <span class="er">(</span><span class="ex">VRF</span> default<span class="kw">)</span><span class="bu">:</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a><span class="ex">BGP</span> router identifier 10.0.0.2, local AS number 65011 vrf-id 0</span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a><span class="ex">BGP</span> table version 9</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a><span class="ex">RIB</span> entries 15, using 2760 bytes of memory</span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a><span class="ex">Peers</span> 3, using 2149 KiB of memory</span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a><span class="ex">Peer</span> groups 2, using 128 bytes of memory</span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a><span class="ex">Neighbor</span>        V         AS    LocalAS   MsgRcvd   MsgSent   TblVer  InQ OutQ  Up/Down State/PfxRcd   PfxSnt Desc</span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a><span class="ex">router0</span><span class="er">(</span><span class="ex">net0</span><span class="kw">)</span>   <span class="ex">4</span>      65000      65011        49        50        0    0    0 00:02:06            6        9 N/A</span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a><span class="ex">10.0.3.2</span>        4          0      65011         0         0        0    0    0    never       Active        0 N/A</span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a><span class="ex">10.0.4.2</span>        4          0      65011         0         0        0    0    0    never       Active        0 N/A</span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true" tabindex="-1"></a><span class="ex">Total</span> number of neighbors 3</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>In the next step, we will be deploying Cilium on the nodes.</p>
<p>üñ•Ô∏è The Cilium CLI</p>
<p>The cilium CLI tool can install and update Cilium on a cluster, as well as activate features ‚Äîsuch as Hubble and Cluster Mesh.</p>
<p>‚ùØ cilium install üîÆ Auto-detected Kubernetes kind: kind ‚ú® Running ‚Äúkind‚Äù validation checks ‚úÖ Detected kind version ‚Äú0.20.0‚Äù ‚ÑπÔ∏è Using Cilium version ‚Äúv1.14.1‚Äù üîÆ Auto-detected cluster name: kind-kind üîÆ Auto-detected kube-proxy has been installed</p>
<p>‚¨¢ The Cilium CLI</p>
<p>The cilium CLI tool is provided in this environment to install and check the status of Cilium in the cluster.</p>
<p>Let‚Äôs start by installing Cilium on the Kind cluster, with BGP enabled.</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="ex">cilium</span> install <span class="dt">\</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>    <span class="at">--version</span> 1.15.0-rc.1 <span class="dt">\</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">--set</span> ipam.mode=kubernetes <span class="dt">\</span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">--set</span> tunnel=disabled <span class="dt">\</span></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">--set</span> ipv4NativeRoutingCIDR=<span class="st">"10.0.0.0/8"</span> <span class="dt">\</span></span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">--set</span> bgpControlPlane.enabled=true <span class="dt">\</span></span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">--set</span> k8s.requireIPv4PodCIDR=true</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>The installation usually takes a couple of minutes. While we wait for the installation to complete, let‚Äôs review some Cilium BGP aspects:</p>
<p>As you can see in the Cilium Helm values above, bgpControlPlane is the main requirement to enable BGP on Cilium. The configuration for BGP peers and Autonomous System Numbers (ASN) will be configured through a Kubernetes CRD (that‚Äôs the next task). For more details on the BGP configuration options, you can read up more on the official Cilium BGP documentation.</p>
<p>The installation should now have finished. Let‚Äôs verify the status of Cilium:</p>
<p><code>cilium status --wait</code></p>
<p>Cilium is now functional on our cluster.</p>
<p>Let‚Äôs verify that BGP has been successfully enabled by checking the Cilium configuration:</p>
<p><code>cilium config view | grep enable-bgp</code></p>
<p>Next, we are going to deploy our BGP Peering Policies and verify that the BGP sessions are established.</p>
<p>‚öôÔ∏è Lab setup Our networking infrastructure is now ready: we can set up peering between our BGP peers and let them exchange routes.</p>
<p>Once BGP is up, we will complete the lab by verifying end-to-end connectivity across our virtual network.</p>
<p>‚öíÔ∏è BGP Configuration Let‚Äôs first walk through the BGP Peering configuration.</p>
<p>Peering policies can be provisioned using simple Kubernetes CRDs, of the kind CiliumBGPPeeringPolicy.</p>
<p><code>yq cilium-bgp-peering-policies.yaml</code></p>
<div class="sourceCode" id="cb8"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="ex">root@server:~#</span> yq cilium-bgp-peering-policies.yaml</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a><span class="ex">---</span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a><span class="ex">apiVersion:</span> <span class="st">"cilium.io/v2alpha1"</span></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a><span class="ex">kind:</span> CiliumBGPPeeringPolicy</span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a><span class="ex">metadata:</span></span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>  <span class="ex">name:</span> rack0</span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a><span class="ex">spec:</span></span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a>  <span class="ex">nodeSelector:</span></span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a>    <span class="ex">matchLabels:</span></span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a>      <span class="ex">rack:</span> rack0</span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a>  <span class="ex">virtualRouters:</span></span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a>    <span class="ex">-</span> localASN: 65010</span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a>      <span class="ex">exportPodCIDR:</span> true</span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true" tabindex="-1"></a>      <span class="ex">neighbors:</span></span>
<span id="cb8-15"><a href="#cb8-15" aria-hidden="true" tabindex="-1"></a>        <span class="ex">-</span> peerAddress: <span class="st">"10.0.0.1/32"</span></span>
<span id="cb8-16"><a href="#cb8-16" aria-hidden="true" tabindex="-1"></a>          <span class="ex">peerASN:</span> 65010</span>
<span id="cb8-17"><a href="#cb8-17" aria-hidden="true" tabindex="-1"></a><span class="ex">---</span></span>
<span id="cb8-18"><a href="#cb8-18" aria-hidden="true" tabindex="-1"></a><span class="ex">apiVersion:</span> <span class="st">"cilium.io/v2alpha1"</span></span>
<span id="cb8-19"><a href="#cb8-19" aria-hidden="true" tabindex="-1"></a><span class="ex">kind:</span> CiliumBGPPeeringPolicy</span>
<span id="cb8-20"><a href="#cb8-20" aria-hidden="true" tabindex="-1"></a><span class="ex">metadata:</span></span>
<span id="cb8-21"><a href="#cb8-21" aria-hidden="true" tabindex="-1"></a>  <span class="ex">name:</span> rack1</span>
<span id="cb8-22"><a href="#cb8-22" aria-hidden="true" tabindex="-1"></a><span class="ex">spec:</span></span>
<span id="cb8-23"><a href="#cb8-23" aria-hidden="true" tabindex="-1"></a>  <span class="ex">nodeSelector:</span></span>
<span id="cb8-24"><a href="#cb8-24" aria-hidden="true" tabindex="-1"></a>    <span class="ex">matchLabels:</span></span>
<span id="cb8-25"><a href="#cb8-25" aria-hidden="true" tabindex="-1"></a>      <span class="ex">rack:</span> rack1</span>
<span id="cb8-26"><a href="#cb8-26" aria-hidden="true" tabindex="-1"></a>  <span class="ex">virtualRouters:</span></span>
<span id="cb8-27"><a href="#cb8-27" aria-hidden="true" tabindex="-1"></a>    <span class="ex">-</span> localASN: 65011</span>
<span id="cb8-28"><a href="#cb8-28" aria-hidden="true" tabindex="-1"></a>      <span class="ex">exportPodCIDR:</span> true</span>
<span id="cb8-29"><a href="#cb8-29" aria-hidden="true" tabindex="-1"></a>      <span class="ex">neighbors:</span></span>
<span id="cb8-30"><a href="#cb8-30" aria-hidden="true" tabindex="-1"></a>        <span class="ex">-</span> peerAddress: <span class="st">"10.0.0.2/32"</span></span>
<span id="cb8-31"><a href="#cb8-31" aria-hidden="true" tabindex="-1"></a>          <span class="ex">peerASN:</span> 65011</span>
<span id="cb8-32"><a href="#cb8-32" aria-hidden="true" tabindex="-1"></a><span class="ex">root@server:~#</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>The key aspects of the policy are:</p>
<p>the remote peer IP address (peerAddress) and AS Number (peerASN) your own local AS Number (localASN) And that‚Äôs it! In this lab, we specify the loopback IP addresses of our BGP peers: the Top of Rack devices tor0 (10.0.0.1/32) and tor1 (10.0.0.2/32).</p>
<p>Note that BGP configuration on Cilium is label-based - the Cilium-managed nodes with a matching label will deploy a virtual router for BGP peering purposes.</p>
<p>Verify the label configuration with the following commands:</p>
<p><code>kubectl get nodes -l 'rack in (rack0,rack1)'</code></p>
<p>For more details on the BGP configuration options, you can read up the official Cilium BGP documentations.</p>
<p>üöÄ Deploy the BGP Peering Policies CRD configuration It‚Äôs time to now deploy the BGP peering policy.</p>
<p><code>kubectl apply -f cilium-bgp-peering-policies.yaml</code></p>
<p>‚úÖ Verify successful BGP peering Now that we have set up our BGP peering, the peering sessions between the Cilium nodes and the Top of Rack switches should be established successfully. Let‚Äôs verify that the sessions have been established and that routes are learned successfully (it might take a few seconds for the sessions to come up).</p>
<p>On tor0:</p>
<p><code>docker exec -it clab-bgp-cplane-demo-tor0 vtysh -c 'show bgp ipv4 summary wide'</code></p>
<p>On tor1:</p>
<p><code>docker exec -it clab-bgp-cplane-demo-tor1 vtysh -c 'show bgp ipv4 summary wide'</code></p>
<p>This time, you should see that the session between the ToR devices and the Cilium nodes are no longer ‚ÄúActive‚Äù (that is to say, unsuccessfully trying to establish peering) but up (you will see how long the session has been up on the Up/Down column).</p>
<p>üöÄ Deploy our networking utility pods We will also be deploying a networking utility called netshoot by using a DaemonSet. We will be using it to verify end-to-end connectivity at the end of the lab.</p>
<p><code>kubectl apply -f netshoot-ds.yaml</code></p>
<pre><code>root@server:~# cat netshoot-ds.yaml
apiVersion: apps/v1
kind: DaemonSet
metadata:
  name: netshoot
spec:
  selector:
    matchLabels:
      app: netshoot
  template:
    metadata:
      labels:
        app: netshoot
    spec:
      tolerations:
      - key: node-role.kubernetes.io/master
        operator: Exists
        effect: NoSchedule
      containers:
      - name: netshoot
        image: nicolaka/netshoot:latest
        command: ["sleep", "infinite"]</code></pre>
<p>To verify the netshoot pods have been successfully deployed, simply run:</p>
<p><code>kubectl rollout status ds/netshoot -w</code></p>
<p>It should take 30 seconds for the Pods to be ready.</p>
<p>‚úÖ Verify end-to-end connectivity</p>
<p>We will now be running a series of connectivity tests, from a source Pod on a node in rack0 to a destination Pod in rack1. These packets will traverse the our virtual networking backbone and validate that the whole data path is working as expected.</p>
<p>Run the following commands.</p>
<p>First, let‚Äôs find the name of a source Pod in rack0.</p>
<p><code>SRC_POD=$(kubectl get pods -o wide | grep "cplane-demo-worker " | awk '{ print($1); }')</code></p>
<p>Next, let‚Äôs get the IP address of a destination Pod in rack1.</p>
<p><code>DST_IP=$(kubectl get pods -o wide | grep worker3 | awk '{ print($6); }')</code></p>
<p>Finally, let‚Äôs execute a ping from the source Pod to the destination IP.</p>
<p><code>kubectl exec -it $SRC_POD -- ping $DST_IP</code></p>
<p>You should see packets flowing across your virtual data center. Well done: your Kubernetes Pods located in different rack servers in your (virtual) datacenter can communicate together across the network backbone! ü•≥</p>
<p>Great job - you have successfully completed this lab and now understand how you can use BGP on Cilium to easily connect your Kubernetes clusters to your DC network.</p>
<p>üõéÔ∏è Service Announcement Cilium can also use BGP to announce Kubernetes service IPs. You can learn about this functionality (and earn a badge) by taking the Load-Balancer IPAM and BGP Service Advertisement lab.</p>
<hr>
<p>‚ùì Final Quiz</p>
<p>In this practical exam, you still have access to the Kind cluster you used in the lab, and Cilium is still installed on it.</p>
<p>However, the BGP peering policies have been removed, and you have to set them up and deploy them again.</p>
<p>You can use the template manifest (cilium-bgp-peering-policy-template.yaml) provided in the current directory and edit them in the &lt;/&gt; Editor tab. Don‚Äôt forget to apply the manifests in the &gt;_ Terminal!</p>
<p>Note You need to create two BGP peering policies: one for rack0 and one for rack1. You can find out the AS numbers for each rack with: docker exec clab-bgp-cplane-demo-router0 vtysh -c ‚Äòshow bgp ipv4 summary‚Äô Remember you will need to set up iBGP (internal BGP, where localASN == peerASN) sessions between the Cilium nodes and the torX devices. You can get the IP addresses of a tor with: docker exec clab-bgp-cplane-demo-torX ip a Use tor IP addresses in the 10.0.0.0/24 range for the peering. If new files don‚Äôt show up in the Editor, you can refresh it. Good luck!</p>
<p>üéì You‚Äôve done it! On completion of this lab, you will receive a badge. Feel free to share your achievement on social media!</p>
<p>Don‚Äôt forget to rate this lab and head over to our home page if you want to learn more!</p>
<p>‚ÜóÔ∏è What‚Äôs next? If you want to learn more about BGP on Cilium, check out the following labs:</p>
<p>Cilium LoadBalancer IPAM and BGP Service Advertisement Advanced BGP Features</p>
<p><code>cilium bgp peers</code></p>



</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "Óßã";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp("https:\/\/alanyoshida\.github\.io\/presentation\/");
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>